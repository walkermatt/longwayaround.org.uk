<!DOCTYPE html>
<html lang="en">
<head>
        <title>longwayaround.org.uk - vector-tiles</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li ><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <abbr class="published" title="2022-06-23T21:56:00+01:00">Thu 23 June 2022</abbr>
                    <h1 class="entry-title"><a href="https://longwayaround.org.uk/notes/web-mercator-os-vector-tile-api-in-openlayers/">Web Mercator OS Vector Tile API in OpenLayers</a></h1> 
                    <p>Adding a Vector Tile layer of Ordnance Survey data from the OS Data Hub to an OpenLayers map in Web Mercator is a little more work than expected as the JSON style document and associated JSON source document include paths for the default British National Grid tiles. The following is based on the output from <a class="reference external" href="https://github.com/openlayers/create-ol-app">create-ol-app</a> and the <a class="reference external" href="https://github.com/OrdnanceSurvey/OS-Data-Hub-API-Demos/tree/master/OSVectorTileAPI/OpenLayers">OS Vector Tile API OpenLayers demo</a>.</p>
<div class="section" id="main-js">
<h2><tt class="docutils literal">main.js</tt></h2>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="s1">&#39;./style.css&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Map</span><span class="p">,</span> <span class="nx">View</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;ol&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">VectorTileLayer</span> <span class="nx">from</span> <span class="s1">&#39;ol/layer/VectorTile&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">VectorTile</span> <span class="nx">from</span> <span class="s1">&#39;ol/source/VectorTile&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">MVT</span> <span class="nx">from</span> <span class="s1">&#39;ol/format/MVT&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">transform</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;ol/proj&#39;</span><span class="p">;</span>

<span class="kr">import</span> <span class="nx">stylefunction</span> <span class="nx">from</span> <span class="s1">&#39;ol-mapbox-style/dist/stylefunction&#39;</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">osApiKey</span> <span class="o">=</span> <span class="s1">&#39;YOUR_OS_API_KEY&#39;</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">vtLyr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VectorTileLayer</span><span class="p">({</span>
  <span class="nx">declutter</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="c1">// Set the layer style to null to avoid, features being displayed with</span>
  <span class="c1">// the default OpenLayers vector styles before the OS styling is applied</span>
  <span class="nx">style</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="c1">// As we&#39;re using the Web Mercator tiles we don&#39;t need to specify the source</span>
  <span class="c1">// projection, TileGrid etc. as OpenLayers defaults to Web Mercator</span>
  <span class="nx">source</span><span class="o">:</span> <span class="k">new</span> <span class="nx">VectorTile</span><span class="p">({</span>
    <span class="nx">format</span><span class="o">:</span> <span class="k">new</span> <span class="nx">MVT</span><span class="p">(),</span>
    <span class="c1">// Specify the tile URL including `srs=3857` so that we request</span>
    <span class="c1">// Web Mercator tiles instead of British National Grid tiles which</span>
    <span class="c1">// are the default when the `srs` parameter is missing</span>
    <span class="nx">url</span><span class="o">:</span>
      <span class="s1">&#39;https://api.os.uk/maps/vector/v1/vts/tile/{z}/{y}/{x}.pbf?srs=3857&amp;key=&#39;</span> <span class="o">+</span> <span class="nx">osApiKey</span><span class="p">,</span>
    <span class="nx">attributions</span><span class="o">:</span>
      <span class="s1">&#39;&amp;copy; &lt;a href=&quot;http://www.ordnancesurvey.co.uk/&quot;&gt;Ordnance Survey&lt;/a&gt;&#39;</span>
  <span class="p">})</span>
<span class="p">});</span>

<span class="c1">// Fetch the Web Mercator JSON style document, note the `srs=3857` query</span>
<span class="c1">// string parameter which is required</span>
<span class="nx">fetch</span><span class="p">(</span>
  <span class="s1">&#39;https://api.os.uk/maps/vector/v1/vts/resources/styles?srs=3857&amp;key=&#39;</span> <span class="o">+</span> <span class="nx">osApiKey</span>
<span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">styleJson</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Look up the JSON sprite document URL and fetch it, note that we&#39;re</span>
    <span class="c1">// updating the URL to include a `.json` extension</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">styleJson</span><span class="p">.</span><span class="nx">sprite</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;?key=&#39;</span><span class="p">,</span> <span class="s1">&#39;.json?key=&#39;</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">spritesJson</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Update the sprite PNG URL to include the `.png` extension</span>
        <span class="kd">let</span> <span class="nx">spritesPngUrl</span> <span class="o">=</span> <span class="nx">styleJson</span><span class="p">.</span><span class="nx">sprite</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;?key=&#39;</span><span class="p">,</span> <span class="s1">&#39;.png?key=&#39;</span><span class="p">);</span>
        <span class="c1">// Call the stylefunction provided by the ol-mapbox-style package</span>
        <span class="c1">// to apply a style Function to our VectorTileLayer instance. This</span>
        <span class="c1">// will replace our `null` style and render the features as per</span>
        <span class="c1">// the JSON style document</span>
        <span class="nx">stylefunction</span><span class="p">(</span>
          <span class="nx">vtLyr</span><span class="p">,</span>
          <span class="nx">styleJson</span><span class="p">,</span>
          <span class="s1">&#39;esri&#39;</span><span class="p">,</span>
          <span class="nx">vtLyr</span><span class="p">.</span><span class="nx">getSource</span><span class="p">().</span><span class="nx">getResolutions</span><span class="p">(),</span>
          <span class="nx">spritesJson</span><span class="p">,</span>
          <span class="nx">spritesPngUrl</span>
        <span class="p">);</span>
      <span class="p">});</span>
  <span class="p">});</span>

<span class="kr">const</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">({</span>
  <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
  <span class="nx">layers</span><span class="o">:</span> <span class="p">[</span><span class="nx">vtLyr</span><span class="p">],</span>
  <span class="nx">view</span><span class="o">:</span> <span class="k">new</span> <span class="nx">View</span><span class="p">({</span>
    <span class="nx">center</span><span class="o">:</span> <span class="nx">transform</span><span class="p">([</span><span class="o">-</span><span class="mf">2.333029</span><span class="p">,</span> <span class="mf">52.109524</span><span class="p">],</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="s1">&#39;EPSG:3857&#39;</span><span class="p">),</span>
    <span class="nx">zoom</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
  <span class="p">}),</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="section" id="index-html">
<h2><tt class="docutils literal">index.html</tt></h2>
<div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;icon&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;image/x-icon&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://openlayers.org/favicon.ico&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="p">/&gt;</span>
    <span class="c">&lt;!-- Include the web font for the OS Vector Tile API styles --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Using OpenLayers with Vite<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;map&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;./main.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>See the comments in the code for an explanation of the steps involved. The you should end up with a map that looks something like this:</p>
<img alt="OpenLayers map showing styled OS Vector Tiles data for Malvern, UK" src="../files/os-vector-tile-openlayers.png" style="width: 100%;" />
</div>
<div class="section" id="what-about-mapboxvector-layer">
<h2>What about MapboxVector layer?</h2>
<p>Ideally we would be able to use the <a class="reference external" href="https://openlayers.org/en/latest/apidoc/module-ol_layer_MapboxVector-MapboxVectorLayer.html">ol/layer/MapboxVector~MapboxVectorLayer</a> instance which would simplify things greatly:</p>
<div class="highlight"><pre><span></span>let osApiKey = &#39;YOUR_OS_API_KEY&#39;;

let vtLyr = new MapboxVectorLayer({
  styleUrl: &#39;https://api.os.uk/maps/vector/v1/vts/resources/styles?srs=3857&amp;key=&#39; + osApiKey
});

const map = new Map({
  target: &#39;map&#39;,
  layers: [vtLyr],
  view: new View({
    center: transform([-2.333029, 52.109524], &#39;EPSG:4326&#39;, &#39;EPSG:3857&#39;),
    zoom: 14,
  }),
});
</pre></div>
<p>However as it currently stands the JSON style document returned by the OS Vector Tile API includes a sprite URL that doesn't include the <cite>srs=3857</cite> parameter and the JSON source document which defines the URL for fetching tiles also doesn't include the <cite>srs</cite> parameter. Because of this we end up loading the Web Mercator style document which then references the British National Grid sprite and source documents which are incompatible.</p>
</div>

<footer class="post-info">
    <abbr class="published" title="2022-06-23T21:56:00+01:00">Thu 23 June 2022</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/javascript.html">javascript</a> <a href="https://longwayaround.org.uk/tag/openlayers.html">openlayers</a> <a href="https://longwayaround.org.uk/tag/vector-tiles.html">vector-tiles</a> </p></footer><!-- /.post-info -->                    <p><a href="https://longwayaround.org.uk/notes/web-mercator-os-vector-tile-api-in-openlayers/#disqus_thread">comments</a>.</p>
                </article>
            </aside><!-- /#featured -->
    </ol><!-- /#posts-list -->
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>