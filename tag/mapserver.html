<!DOCTYPE html>
<html lang="en">
<head>
        <title>longwayaround.org.uk - mapserver</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li ><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr>
                    <h1 class="entry-title"><a href="https://longwayaround.org.uk/notes/mapserver-postgis-performance/">MapServer PostGIS Performance</a></h1> 
                    <p>Recently I was looking at improving the performance of rendering a <a class="reference external" href="https://github.com/spacesyntax/OpenMapping">Space Syntax OpenMapping</a> layer in MapServer. The <code>openmapping_gb_v1</code> table is in a PostGIS database with an index on the geometry column. The original MapServer <code>DATA</code> configuration looked like this:</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (select meridian_class_scale * 10 as line_width, * from openmapping.openmapping_gb_v1 order by choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>The main thing to note is that the rows are sorted by the <code>choice2kmrank</code> value to ensure features are rendered in the correct order (a similar problem as described in <a class="reference external" href="http://mapgears.com/en/blog/archive/2013-03-05-roads_network_mapping">Mapping a road network with MapServer - Understanding the display order</a>).</p>
<p>This SQL results in the following query being executed by MapServer:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="o">*</span>
<span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">);</span>
</pre></div>
<p>There are two issues with the original query performance-wise:</p>
<div class="section" id="ordering-too-many-rows">
<h2>1. Ordering too many rows</h2>
<p>The order by clause is within the inner query, so it sorts all rows in <code>openmapping.openmapping_gb_v1</code>, not just those that fall within the spatial filter. This is fine for tables with a small number of rows, but has a significant impact for larger tables.</p>
</div>
<div class="section" id="spatial-index-not-being-used">
<h2>2. Spatial index not being used</h2>
<p>By default MapServer represents the spatial filter as an inline geometry, which often results in Postgres applying the bounding box spatial filter without using the spatial index. This can be seen here when running <code>EXPLAIN SELECT ...</code> to generate an execution plan.</p>
</div>
<div class="section" id="solution">
<h2>Solution</h2>
<p>Ideally we want to only sort those rows returned by the spatial filter, as well as having the spatial filter use the spatial index.</p>
<p>MapServer provides a special <code>!BOX!</code> placeholder that can be inserted into a SQL query, which dictates where the <code>ST_GeomFromText('POLGON...</code> statement appears when MapServer constructs the SQL to execute. At the time of writing the <code>!BOX!</code> placeholder is described in <a class="reference external" href="https://mapserver.org/input/vector/postgis.html#data-access-connection-method">the last example in the PostGIS Data Access documentation</a>.</p>
<p>By using the <code>!BOX!</code> placeholder we can combine the spatial filter and sort into a single select statement:</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (select meridian_class_scale * 10 as line_width, * from openmapping.openmapping_gb_v1 where wkb_geometry &amp;&amp; !BOX! order by choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>Results in MapServer generating:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="o">*</span>
<span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span>
<span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
<p>To improve the likelihood that the spatial index is used, we can use a technique described by <a class="reference external" href="https://gis.stackexchange.com/users/429/john-powell">John Powell</a> in <a class="reference external" href="https://gis.stackexchange.com/a/253987/6004">this gis.stackexchange.com answer</a>, which involves moving the geometry creation to a <a class="reference external" href="https://www.postgresql.org/docs/11/queries-with.html">CTE (Common Table Expression)</a> resulting in the query optimiser having prior knowledge of the geometry which generally results in the spatial index being used.</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (WITH box (geom) AS (SELECT !BOX! as geom) SELECT fid, wkb_geometry, choice2kmrank, meridian_class_scale * 10 AS line_width FROM openmapping.openmapping_gb_v1, box WHERE wkb_geometry &amp;&amp; box.geom ORDER BY choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>Results in MapServer generating:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">WITH</span> <span class="n">box</span> <span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span>
        <span class="p">(</span><span class="k">SELECT</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">)</span>
    <span class="k">SELECT</span> <span class="n">fid</span><span class="p">,</span>
            <span class="n">wkb_geometry</span><span class="p">,</span>
            <span class="n">choice2kmrank</span><span class="p">,</span>
            <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span>
    <span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span><span class="p">,</span>
        <span class="n">box</span>
    <span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">box</span><span class="p">.</span><span class="n">geom</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
<p>With this change we're now using the spatial index when applying the spatial filter, then only sorting the filtered rows. In my case the query execution time went from several seconds to less than 500ms with identical results.</p>
<p>Thanks to <a class="reference external" href="https://twitter.com/devsupportman">Peter Goulborn</a> and <a class="reference external" href="https://twitter.com/ijturton">Ian Turton</a> for their help getting to the final solution.</p>
</div>

<footer class="post-info">
    <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/mapserver.html">mapserver</a> <a href="https://longwayaround.org.uk/tag/postgres.html">postgres</a> <a href="https://longwayaround.org.uk/tag/postgis.html">postgis</a> <a href="https://longwayaround.org.uk/tag/notes.html">notes</a> </p></footer><!-- /.post-info -->                    <p><a href="https://longwayaround.org.uk/notes/mapserver-postgis-performance/#disqus_thread">comments</a>.</p>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other posts</h1>
                    <hr />
                        <ol id="posts-list" class="hfeed">

 
            <li><article class="hentry">
                <header>
                        <abbr class="published" title="2012-02-02T21:31:00+00:00">Thu 02 February 2012</abbr>
                        <h1><a href="https://longwayaround.org.uk/notes/greyscale-maps-with-mapserver/" rel="bookmark" title="Permalink to Greyscale maps with MapServer">Greyscale maps with MapServer</a></h1>
                </header>
                <div class="entry-content">
                <div class="slug">
                    <p>There have been a few times in the past (such as when I was preparing the base mapping for <a class="reference external" href="http://mywycombe.wycombe.gov.uk/?tab=2">My Wycombe</a>) when I've wanted to create greyscale base mapping using <a class="reference external" href="http://mapserver.org">MapServer</a>. Previously I've experimented with various processing options for raster images (with varying degrees of success), converting the source images …</p>
                    <p>
<a href="https://longwayaround.org.uk/notes/greyscale-maps-with-mapserver/#disqus_thread">comments</a>.                        <a class="readmore" href="https://longwayaround.org.uk/notes/greyscale-maps-with-mapserver/">read more</a>
                    </p>
                </div>
                </div><!-- /.entry-content -->
            </article></li>
    </ol><!-- /#posts-list -->
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>