<!DOCTYPE html>
<html lang="en">
<head>
        <title>Moving gridref to fly.io</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li class="active"><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->
<section id="content" class="body">
<article>
        <abbr class="published" title="2023-03-27T11:20:00+01:00">Mon 27 March 2023</abbr>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Moving gridref to fly.io">Moving gridref to fly.io</a></h1>  </header>
        <div class="entry-content">
        <p>A few years ago I made an effort to learn <a class="reference external" href="http://clojure.org/">Clojure</a>, during which time I built a small Clojure library and command-line app <a class="reference external" href="https://github.com/walkermatt/gridref">GridRef</a> to convert between an Ordnance Survey GB grid reference and British National Grid coordinates. While I was at it I built a web API <a class="reference external" href="https://github.com/walkermatt/gridref-web">GridRef Web</a> which exposes the conversion functions via a <a class="reference external" href="https://github.com/ring-clojure/ring">Ring</a> web app. For several years gridref-web was deployed via Heroku on it's free-tier, following the free-tier coming to an end it needed a new home.</p>
<p>I saw mention of <a class="reference external" href="https://fly.io/">fly.io</a> a little while ago and saw they had a <a class="reference external" href="https://fly.io/docs/about/pricing/#free-allowances">genorious free tier</a> including support for custom domains, https and deployment via Docker so I thought I'd give it a go.</p>
<div class="section" id="creating-a-dockerfile">
<h2>Creating a Dockerfile</h2>
<p>The first step was to create a Docker container which turned out to be straight forward. This is the <code>Dockerfile</code> which is based on the <a class="reference external" href="https://hub.docker.com/_/clojure/">official clojure Docker image</a>:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> clojure</span>
<span class="k">ENV</span> <span class="nv">PORT</span><span class="o">=</span><span class="m">8080</span>
<span class="k">ENV</span> <span class="nv">JVM_OPTS</span><span class="o">=</span><span class="s2">&quot;-Xmx250m&quot;</span>
<span class="k">COPY</span> . /usr/src/app
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>
<span class="k">EXPOSE</span><span class="s"> ${PORT}</span>
<span class="k">CMD</span> lein run <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PORT</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
<p>First we define a <code>PORT</code> environment variable which determines which port the embedded Jetty HTTP server will listen on. I'm defaulting to <code>8080</code> which is the default http port that fly.io will forward http requests to.</p>
<p>The <code>JVM_OPTS</code> environment variable is used to limit the amount of memory that our app can use, I've chosen <code>250m</code> which is slightly lower than the memory available to a fly.io instance on the <a class="reference external" href="https://fly.io/docs/about/pricing/#free-allowances">free tier</a>.</p>
<p>We then copy the contents of the repo to <code>/usr/src/app</code>, set the current directory (<code>WORKDIR</code>) to the same and <code>EXPOSE</code> the <code>PORT</code>.</p>
<p>Finally we start the app via <code>lein run</code> passing the value of the <code>PORT</code> environment variable which is handled by the <a class="reference external" href="https://github.com/walkermatt/gridref-web/blob/master/src/gridref_web/web.clj#L95">main method of GridRef Web</a>.</p>
</div>
<div class="section" id="build-and-run-locally">
<h2>Build and run locally</h2>
<p>The <code>Dockerfile</code> can be built and run locally via:</p>
<div class="highlight"><pre><span></span>docker build -t gridref-web .
docker run -it --rm --memory-swap 250m --memory 250m --env <span class="nv">PORT</span><span class="o">=</span><span class="m">8181</span> -p <span class="m">8181</span>:8181 --name gridref-web gridref-web
</pre></div>
<p>Specifying the same value for <cite>--memory-swap</cite> and <cite>--memory</cite> effectively limits the container to that much memory without swap which mimics the fly.io free-tier.</p>
<p>We're setting the <code>PORT</code> environment variable used in the Dockerfile to determine which port the Jetty listens on; the <code>-p</code> option exposes the container port to localhost for testing.</p>
<p>Visiting <code>http://localhost:8181</code> should load the home page.</p>
</div>
<div class="section" id="deploy-to-fly-io">
<h2>Deploy to fly.io</h2>
<p>First download and install <a class="reference external" href="https://fly.io/docs/#flyctl-your-cli-command-center">flyctl</a> before running the following to authenticate (and create an account):</p>
<div class="highlight"><pre><span></span>flyctl auth login
</pre></div>
<p>Then change to the root of the <code>gridref-web</code> repository and execute the following to configure the app for deployment via fly.io:</p>
<div class="highlight"><pre><span></span>flyctl launch
</pre></div>
<p>Running <code>flyctl launch</code> prompts for various options (shown below) and creates a <code>fly.toml</code> file which contains the apps configuration.</p>
<div class="highlight"><pre><span></span><span class="c1"># ? Choose an app name (leave blank to generate one): gridref-web</span>
<span class="c1"># ? Choose a region for deployment: London, United Kingdom (lhr)</span>
<span class="c1"># Created app &#39;gridref-web&#39; in organization &#39;personal&#39;</span>
<span class="c1"># ? Would you like to set up a Postgresql database now? No</span>
<span class="c1"># ? Would you like to set up an Upstash Redis database now? No</span>
<span class="c1"># ? Create .dockerignore from 3 .gitignore files? Yes</span>
<span class="c1"># ? Would you like to deploy now? No</span>
</pre></div>
<p>These choices resulted in the following <code>fly.toml</code>:</p>
<div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="s">&quot;gridref-web&quot;</span>
<span class="n">kill_signal</span> <span class="o">=</span> <span class="s">&quot;SIGINT&quot;</span>
<span class="n">kill_timeout</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">primary_region</span> <span class="o">=</span> <span class="s">&quot;lhr&quot;</span>
<span class="n">processes</span> <span class="o">=</span> <span class="k">[]</span>

<span class="k">[env]</span>

<span class="k">[experimental]</span>
  <span class="n">auto_rollback</span> <span class="o">=</span> <span class="kc">true</span>

<span class="k">[[services]]</span>
  <span class="n">http_checks</span> <span class="o">=</span> <span class="k">[]</span>
  <span class="n">internal_port</span> <span class="o">=</span> <span class="mi">8080</span>
  <span class="n">processes</span> <span class="o">=</span> <span class="k">[&quot;app&quot;]</span>
  <span class="n">protocol</span> <span class="o">=</span> <span class="s">&quot;tcp&quot;</span>
  <span class="n">script_checks</span> <span class="o">=</span> <span class="k">[]</span>
  <span class="k">[services.concurrency]</span>
    <span class="n">hard_limit</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">soft_limit</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">type</span> <span class="o">=</span> <span class="s">&quot;connections&quot;</span>

  <span class="k">[[services.ports]]</span>
    <span class="n">force_https</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">handlers</span> <span class="o">=</span> <span class="k">[&quot;http&quot;]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">80</span>

  <span class="k">[[services.ports]]</span>
    <span class="n">handlers</span> <span class="o">=</span> <span class="k">[&quot;tls&quot;, &quot;http&quot;]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">443</span>

  <span class="k">[[services.tcp_checks]]</span>
    <span class="n">grace_period</span> <span class="o">=</span> <span class="s">&quot;1s&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="s">&quot;15s&quot;</span>
    <span class="n">restart_limit</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="s">&quot;2s&quot;</span>
</pre></div>
<p>I couldn't see any obvious changes to <code>fly.toml</code> so I moved onto deploying via:</p>
<div class="highlight"><pre><span></span>flyctl deploy
</pre></div>
<p>At this point the gridref-web application is available at <a class="reference external" href="https://gridref-web.fly.dev/">https://gridref-web.fly.dev/</a>.</p>
<p>The application is available by default via https on fly.io (with a redirect from http), I had to make a <a class="reference external" href="https://github.com/walkermatt/gridref-web/commit/ff2b5b6bb62ec78f2816ae48ffda8e9b68c1efde">small change to the code</a> to use the <code>x-forwarded-proto</code> header to determine the client protocol to ensure the links shown on the home page use the correct protocol as fly.io makes requests to my application running in Docker via plain http.</p>
</div>
<div class="section" id="custom-domain-and-certificate">
<h2>Custom domain and certificate</h2>
<p>Setting up a custom domain and associated certificate for http traffic involved:</p>
<ol class="arabic simple">
<li>Creating a CNAME to point <code>gridref.longwayaround.org.uk</code> at <code>gridref-web.fly.dev.</code></li>
<li>Once the CNAME had propagated, requesting a certificate via the <cite>flyctl</cite>:</li>
</ol>
<div class="highlight"><pre><span></span>flyctl certs create gridref.longwayaround.org.uk
</pre></div>
<p>The web application is now available at <a class="reference external" href="https://gridref.longwayaround.org.uk/">https://gridref.longwayaround.org.uk/</a> 🎉</p>
<p>The application has been running for a few weeks without any issues, it's now running via https and is more responsive due to the instance always being available.</p>
</div>

<footer class="post-info">
    <abbr class="published" title="2023-03-27T11:20:00+01:00">Mon 27 March 2023</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/command-line.html">command-line</a> <a href="https://longwayaround.org.uk/tag/geo.html">geo</a> <a href="https://longwayaround.org.uk/tag/clojure.html">clojure</a> <a href="https://longwayaround.org.uk/tag/notes.html">notes</a> </p></footer><!-- /.post-info -->        </div><!-- /.entry-content -->
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               // Don't set the identifier so that comments are
               // associated with the url
               // var disqus_identifier = "notes/moving-gridref-to-flyio/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'https://longwayaroundorguk.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>

</article>
</section>
<section id="content" class="body">
<h1>Posts</h1>
<ul>
    <li><a href='../../notes/moving-gridref-to-flyio/'>Moving gridref to fly.io</a> - <abbr class="published" title="2023-03-27T11:20:00+01:00">Mon 27 March 2023</abbr></li>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers-take-2/'>Web Mercator OS Vector Tile API in OpenLayers - Take #2</a> - <abbr class="published" title="2022-09-05T08:05:00+01:00">Mon 05 September 2022</abbr></li>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers/'>Web Mercator OS Vector Tile API in OpenLayers</a> - <abbr class="published" title="2022-06-23T21:56:00+01:00">Thu 23 June 2022</abbr></li>
    <li><a href='../../notes/writing-small-text-filters-for-the-shell-and-vim/'>Writing small text filters for the shell and Vim</a> - <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr></li>
    <li><a href='../../notes/mapserver-postgis-performance/'>MapServer PostGIS Performance</a> - <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr></li>
    <li><a href='../../notes/postgres-information-functions/'>Postgres Information Functions</a> - <abbr class="published" title="2017-02-18T07:55:00+00:00">Sat 18 February 2017</abbr></li>
    <li><a href='../../notes/openlayers-2-custom-build/'>OpenLayers 2 Custom Build</a> - <abbr class="published" title="2016-04-26T14:00:00+01:00">Tue 26 April 2016</abbr></li>
    <li><a href='../../notes/testing-python-postgres/'>Testing Python &amp; Postgres</a> - <abbr class="published" title="2015-10-12T21:00:00+01:00">Mon 12 October 2015</abbr></li>
    <li><a href='../../notes/read-only-postgres-database/'>Read-only Postgres database</a> - <abbr class="published" title="2015-09-08T13:00:00+01:00">Tue 08 September 2015</abbr></li>
    <li><a href='../../notes/loading-postgis/'>Loading PostGIS</a> - <abbr class="published" title="2014-11-20T00:00:00+00:00">Thu 20 November 2014</abbr></li>
    <li><a href='../../notes/practical-openlayers-3-leaflet/'>Practical OpenLayers 3 &amp; Leaflet</a> - <abbr class="published" title="2014-09-07T21:30:00+01:00">Sun 07 September 2014</abbr></li>
    <li><a href='../../notes/gnu-parallel-all-the-things/'>GNU Parallel all the things!</a> - <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr></li>
    <li><a href='../../notes/first-few-months-of-clojure/'>First few months of Clojure</a> - <abbr class="published" title="2014-02-18T19:42:00+00:00">Tue 18 February 2014</abbr></li>
    <li><a href='../../notes/custom-geoserver-getfeatureinfo-template/'>Custom GeoServer GetFeatureInfo Template</a> - <abbr class="published" title="2013-10-18T17:24:00+01:00">Fri 18 October 2013</abbr></li>
    <li><a href='../../notes/using-leaflet-with-a-custom-projection-and-a-mapproxy-tms/'>Using Leaflet with a custom projection and a MapProxy TMS</a> - <abbr class="published" title="2012-07-02T21:06:00+01:00">Mon 02 July 2012</abbr></li>
    <li><a href='../../notes/greyscale-maps-with-mapserver/'>Greyscale maps with MapServer</a> - <abbr class="published" title="2012-02-02T21:31:00+00:00">Thu 02 February 2012</abbr></li>
    <li><a href='../../notes/disaggregate-multilinestrings-using-st_dump-postgis/'>Disaggregate MultiLineStrings using ST_Dump PostGIS</a> - <abbr class="published" title="2011-11-24T21:39:00+00:00">Thu 24 November 2011</abbr></li>
    <li><a href='../../notes/recursively-delete-empty-directories/'>Recursively delete empty directories</a> - <abbr class="published" title="2011-03-28T10:31:00+01:00">Mon 28 March 2011</abbr></li>
    <li><a href='../../notes/convert-a-directory-of-tiffs-to-greyscale-using-imagemagick/'>Convert a directory of TIFFs to greyscale using ImageMagick</a> - <abbr class="published" title="2011-01-07T17:53:00+00:00">Fri 07 January 2011</abbr></li>
    <li><a href='../../notes/build-ogr-18-with-gml-wfs-and-postgis-support-on-ubuntu-1004/'>Build OGR 1.8 with GML, WFS and PostGIS support on Ubuntu 10.04</a> - <abbr class="published" title="2010-12-19T21:06:00+00:00">Sun 19 December 2010</abbr></li>
</ul>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>