<!DOCTYPE html>
<html lang="en">
<head>
        <title>MapServer PostGIS Performance</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li class="active"><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->
<section id="content" class="body">
<article>
        <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to MapServer PostGIS Performance">MapServer PostGIS Performance</a></h1>  </header>
        <div class="entry-content">
        <p>Recently I was looking at improving the performance of rendering a <a class="reference external" href="https://github.com/spacesyntax/OpenMapping">Space Syntax OpenMapping</a> layer in MapServer. The <code>openmapping_gb_v1</code> table is in a PostGIS database with an index on the geometry column. The original MapServer <code>DATA</code> configuration looked like this:</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (select meridian_class_scale * 10 as line_width, * from openmapping.openmapping_gb_v1 order by choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>The main thing to note is that the rows are sorted by the <code>choice2kmrank</code> value to ensure features are rendered in the correct order (a similar problem as described in <a class="reference external" href="http://mapgears.com/en/blog/archive/2013-03-05-roads_network_mapping">Mapping a road network with MapServer - Understanding the display order</a>).</p>
<p>This SQL results in the following query being executed by MapServer:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="o">*</span>
<span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span>
<span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">);</span>
</pre></div>
<p>There are two issues with the original query performance-wise:</p>
<div class="section" id="ordering-too-many-rows">
<h2>1. Ordering too many rows</h2>
<p>The order by clause is within the inner query, so it sorts all rows in <code>openmapping.openmapping_gb_v1</code>, not just those that fall within the spatial filter. This is fine for tables with a small number of rows, but has a significant impact for larger tables.</p>
</div>
<div class="section" id="spatial-index-not-being-used">
<h2>2. Spatial index not being used</h2>
<p>By default MapServer represents the spatial filter as an inline geometry, which often results in Postgres applying the bounding box spatial filter without using the spatial index. This can be seen here when running <code>EXPLAIN SELECT ...</code> to generate an execution plan.</p>
</div>
<div class="section" id="solution">
<h2>Solution</h2>
<p>Ideally we want to only sort those rows returned by the spatial filter, as well as having the spatial filter use the spatial index.</p>
<p>MapServer provides a special <code>!BOX!</code> placeholder that can be inserted into a SQL query, which dictates where the <code>ST_GeomFromText('POLGON...</code> statement appears when MapServer constructs the SQL to execute. At the time of writing the <code>!BOX!</code> placeholder is described in <a class="reference external" href="https://mapserver.org/input/vector/postgis.html#data-access-connection-method">the last example in the PostGIS Data Access documentation</a>.</p>
<p>By using the <code>!BOX!</code> placeholder we can combine the spatial filter and sort into a single select statement:</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (select meridian_class_scale * 10 as line_width, * from openmapping.openmapping_gb_v1 where wkb_geometry &amp;&amp; !BOX! order by choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>Results in MapServer generating:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span><span class="p">,</span>
        <span class="o">*</span>
<span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span>
<span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
<p>To improve the likelihood that the spatial index is used, we can use a technique described by <a class="reference external" href="https://gis.stackexchange.com/users/429/john-powell">John Powell</a> in <a class="reference external" href="https://gis.stackexchange.com/a/253987/6004">this gis.stackexchange.com answer</a>, which involves moving the geometry creation to a <a class="reference external" href="https://www.postgresql.org/docs/11/queries-with.html">CTE (Common Table Expression)</a> resulting in the query optimiser having prior knowledge of the geometry which generally results in the spatial index being used.</p>
<div class="highlight"><pre><span></span>DATA &quot;wkb_geometry from (WITH box (geom) AS (SELECT !BOX! as geom) SELECT fid, wkb_geometry, choice2kmrank, meridian_class_scale * 10 AS line_width FROM openmapping.openmapping_gb_v1, box WHERE wkb_geometry &amp;&amp; box.geom ORDER BY choice2kmrank) as a using unique fid using srid=27700&quot;
</pre></div>
<p>Results in MapServer generating:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;choice2kmrank&quot;</span><span class="p">,</span>
    <span class="ss">&quot;line_width&quot;</span><span class="p">,</span>
    <span class="n">encode</span><span class="p">(</span><span class="n">ST_AsBinary</span><span class="p">(</span><span class="n">ST_Force_2D</span><span class="p">(</span><span class="ss">&quot;wkb_geometry&quot;</span><span class="p">),</span><span class="s1">&#39;NDR&#39;</span><span class="p">),</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">,</span>
    <span class="ss">&quot;fid&quot;</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">WITH</span> <span class="n">box</span> <span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">AS</span>
        <span class="p">(</span><span class="k">SELECT</span> <span class="n">ST_GeomFromText</span><span class="p">(</span><span class="s1">&#39;POLYGON((441580.992440577 112973.855285226,441580.992440577 115008.987681971,443621.486046148 115008.987681971,443621.486046148 112973.855285226,441580.992440577 112973.855285226))&#39;</span><span class="p">,</span><span class="mi">27700</span><span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span><span class="p">)</span>
    <span class="k">SELECT</span> <span class="n">fid</span><span class="p">,</span>
            <span class="n">wkb_geometry</span><span class="p">,</span>
            <span class="n">choice2kmrank</span><span class="p">,</span>
            <span class="n">meridian_class_scale</span> <span class="o">*</span> <span class="mi">10</span> <span class="k">AS</span> <span class="n">line_width</span>
    <span class="k">FROM</span> <span class="n">openmapping</span><span class="p">.</span><span class="n">openmapping_gb_v1</span><span class="p">,</span>
        <span class="n">box</span>
    <span class="k">WHERE</span> <span class="n">wkb_geometry</span> <span class="o">&amp;&amp;</span> <span class="n">box</span><span class="p">.</span><span class="n">geom</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">choice2kmrank</span><span class="p">)</span> <span class="k">AS</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
<p>With this change we're now using the spatial index when applying the spatial filter, then only sorting the filtered rows. In my case the query execution time went from several seconds to less than 500ms with identical results.</p>
<p>Thanks to <a class="reference external" href="https://twitter.com/devsupportman">Peter Goulborn</a> and <a class="reference external" href="https://twitter.com/ijturton">Ian Turton</a> for their help getting to the final solution.</p>
</div>

<footer class="post-info">
    <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/mapserver.html">mapserver</a> <a href="https://longwayaround.org.uk/tag/postgres.html">postgres</a> <a href="https://longwayaround.org.uk/tag/postgis.html">postgis</a> <a href="https://longwayaround.org.uk/tag/notes.html">notes</a> </p></footer><!-- /.post-info -->        </div><!-- /.entry-content -->
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               // Don't set the identifier so that comments are
               // associated with the url
               // var disqus_identifier = "notes/mapserver-postgis-performance/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'https://longwayaroundorguk.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>

</article>
</section>
<section id="content" class="body">
<h1>Posts</h1>
<ul>
    <li><a href='../../notes/moving-gridref-to-flyio/'>Moving gridref to fly.io</a> - <abbr class="published" title="2023-03-27T11:20:00+01:00">Mon 27 March 2023</abbr></li>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers-take-2/'>Web Mercator OS Vector Tile API in OpenLayers - Take #2</a> - <abbr class="published" title="2022-09-05T08:05:00+01:00">Mon 05 September 2022</abbr></li>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers/'>Web Mercator OS Vector Tile API in OpenLayers</a> - <abbr class="published" title="2022-06-23T21:56:00+01:00">Thu 23 June 2022</abbr></li>
    <li><a href='../../notes/writing-small-text-filters-for-the-shell-and-vim/'>Writing small text filters for the shell and Vim</a> - <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr></li>
    <li><a href='../../notes/mapserver-postgis-performance/'>MapServer PostGIS Performance</a> - <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr></li>
    <li><a href='../../notes/postgres-information-functions/'>Postgres Information Functions</a> - <abbr class="published" title="2017-02-18T07:55:00+00:00">Sat 18 February 2017</abbr></li>
    <li><a href='../../notes/openlayers-2-custom-build/'>OpenLayers 2 Custom Build</a> - <abbr class="published" title="2016-04-26T14:00:00+01:00">Tue 26 April 2016</abbr></li>
    <li><a href='../../notes/testing-python-postgres/'>Testing Python &amp; Postgres</a> - <abbr class="published" title="2015-10-12T21:00:00+01:00">Mon 12 October 2015</abbr></li>
    <li><a href='../../notes/read-only-postgres-database/'>Read-only Postgres database</a> - <abbr class="published" title="2015-09-08T13:00:00+01:00">Tue 08 September 2015</abbr></li>
    <li><a href='../../notes/loading-postgis/'>Loading PostGIS</a> - <abbr class="published" title="2014-11-20T00:00:00+00:00">Thu 20 November 2014</abbr></li>
    <li><a href='../../notes/practical-openlayers-3-leaflet/'>Practical OpenLayers 3 &amp; Leaflet</a> - <abbr class="published" title="2014-09-07T21:30:00+01:00">Sun 07 September 2014</abbr></li>
    <li><a href='../../notes/gnu-parallel-all-the-things/'>GNU Parallel all the things!</a> - <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr></li>
    <li><a href='../../notes/first-few-months-of-clojure/'>First few months of Clojure</a> - <abbr class="published" title="2014-02-18T19:42:00+00:00">Tue 18 February 2014</abbr></li>
    <li><a href='../../notes/custom-geoserver-getfeatureinfo-template/'>Custom GeoServer GetFeatureInfo Template</a> - <abbr class="published" title="2013-10-18T17:24:00+01:00">Fri 18 October 2013</abbr></li>
    <li><a href='../../notes/using-leaflet-with-a-custom-projection-and-a-mapproxy-tms/'>Using Leaflet with a custom projection and a MapProxy TMS</a> - <abbr class="published" title="2012-07-02T21:06:00+01:00">Mon 02 July 2012</abbr></li>
    <li><a href='../../notes/greyscale-maps-with-mapserver/'>Greyscale maps with MapServer</a> - <abbr class="published" title="2012-02-02T21:31:00+00:00">Thu 02 February 2012</abbr></li>
    <li><a href='../../notes/disaggregate-multilinestrings-using-st_dump-postgis/'>Disaggregate MultiLineStrings using ST_Dump PostGIS</a> - <abbr class="published" title="2011-11-24T21:39:00+00:00">Thu 24 November 2011</abbr></li>
    <li><a href='../../notes/recursively-delete-empty-directories/'>Recursively delete empty directories</a> - <abbr class="published" title="2011-03-28T10:31:00+01:00">Mon 28 March 2011</abbr></li>
    <li><a href='../../notes/convert-a-directory-of-tiffs-to-greyscale-using-imagemagick/'>Convert a directory of TIFFs to greyscale using ImageMagick</a> - <abbr class="published" title="2011-01-07T17:53:00+00:00">Fri 07 January 2011</abbr></li>
    <li><a href='../../notes/build-ogr-18-with-gml-wfs-and-postgis-support-on-ubuntu-1004/'>Build OGR 1.8 with GML, WFS and PostGIS support on Ubuntu 10.04</a> - <abbr class="published" title="2010-12-19T21:06:00+00:00">Sun 19 December 2010</abbr></li>
</ul>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>