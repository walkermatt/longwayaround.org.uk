<!DOCTYPE html>
<html lang="en">
<head>
        <title>GNU Parallel all the things!</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li class="active"><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->
<section id="content" class="body">
<article>
        <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to GNU Parallel all the things!">GNU Parallel all the things!</a></h1>  </header>
        <div class="entry-content">
        <p>I've been doing a lot of data processing recently and have been looking for a way of running bulk data loads into PostGIS in parallel to make use of all available cores. The work has mainly revolved around loading national cover of Ordnance Survey OS MasterMap and VectorMap Local for <a class="reference external" href="http://astuntechnology.com/">Astun Tech's</a> base map services using <a class="reference external" href="https://github.com/AstunTechnology/Loader">Loader</a>. Loader doesn't have any parallel processing baked in but a <a class="reference external" href="https://github.com/AstunTechnology/Loader/commit/199e66f7064e341b1365eb10a3d5a572b45b7fdb">small change to how it creates it's temporary directory</a> allows multiple instance to be ran in parallel each processing a single file at a time. The key component to enable this is <a class="reference external" href="http://www.gnu.org/software/parallel/">GNU Parallel</a>, from the projects homepage:</p>
<blockquote>
GNU parallel is a shell tool for executing jobs in parallel using one or more computers. A job can be a single command or a small script that has to be run for each of the lines in the input. The typical input is a list of files, a list of hosts, a list of users, a list of URLs, or a list of tables. A job can also be a command that reads from a pipe. GNU parallel can then split the input and pipe it into commands in parallel.</blockquote>
<p>The way I've been using Parallel with Loader is to build a list of files to process using <tt class="docutils literal">find</tt> which is piped to <tt class="docutils literal">parallel</tt> which handles executing as many processes as there are cores (by default). For example:</p>
<div class="highlight"><pre><span></span>find /var/data/osmm/ -type f -print0 <span class="p">|</span> <span class="se">\</span>
parallel -0 python loader.py loader.config <span class="s2">&quot;src_dir={}&quot;</span>
</pre></div>
<p>Using this approach on an 8 core EC2 server with SSD volumes national OS MasterMap Topography Layer can be loaded over a weekend.</p>
<p>Another example of using <tt class="docutils literal">parallel</tt> would be to build on the bash one-liner that Tim Sutton posted a while back to <a class="reference external" href="http://linfiniti.com/2012/03/another-bash-one-liner-load-all-natural-earth-layers-into-postgis-in-one-go/">load all natural earth layers into PostGIS in one go</a>. Tim's original command used <tt class="docutils literal">find</tt> to build a list of files then loops over the list and runs <tt class="docutils literal">shp2pgsql</tt> for each piping the output to <tt class="docutils literal">psql</tt> to do the actual load. Here's the original command tweaked slightly to exclude the <tt class="docutils literal">tools</tt> directory and specify the encoding including timing:</p>
<div class="highlight"><pre><span></span><span class="nb">time</span> <span class="k">for</span> FILE in <span class="sb">`</span>find . -name <span class="s1">&#39;*.shp&#39;</span> -not -path <span class="s2">&quot;./tools/*&quot;</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
<span class="nv">BASE</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$FILE</span> .shp<span class="sb">`</span><span class="p">;</span> <span class="se">\</span>
shp2pgsql -W LATIN1 -s <span class="m">4326</span> -I <span class="nv">$FILE</span> world.<span class="nv">$BASE</span> <span class="se">\</span>
<span class="p">|</span> psql<span class="p">;</span> <span class="k">done</span>

real        6m14.569s
</pre></div>
<p>The example below is the equivalent using <cite>parallel</cite> which significantly reduces load time:</p>
<div class="highlight"><pre><span></span><span class="nb">time</span> find . -name <span class="s1">&#39;*.shp&#39;</span> -not -path <span class="s2">&quot;./tools/*&quot;</span> <span class="se">\</span>
<span class="p">|</span> parallel <span class="s2">&quot;shp2pgsql -W LATIN1 -s 4326 -I {} world.{/.} | psql&quot;</span>

real        3m11.030s
</pre></div>
<p>Again <tt class="docutils literal">find</tt> is used to build a list of input shapefiles which are piped to <tt class="docutils literal">parallel</tt> which builds and executes the <tt class="docutils literal">shp2pgsql</tt> and <tt class="docutils literal">psql</tt> combination. By default <tt class="docutils literal">parallel</tt> provides the <tt class="docutils literal">{}</tt> replacement string for the current argument (file path in this case) and <tt class="docutils literal"><span class="pre">{/.}</span></tt> which strips the path and extension from when the replacement string is a file path.</p>

<footer class="post-info">
    <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/command-line.html">command-line</a> <a href="https://longwayaround.org.uk/tag/postgis.html">postgis</a> <a href="https://longwayaround.org.uk/tag/notes.html">notes</a> </p></footer><!-- /.post-info -->        </div><!-- /.entry-content -->
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               // Don't set the identifier so that comments are
               // associated with the url
               // var disqus_identifier = "notes/gnu-parallel-all-the-things/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'https://longwayaroundorguk.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>

</article>
</section>
<section id="content" class="body">
<h1>Posts</h1>
<ul>
    <li><a href='../../notes/writing-small-text-filters-for-the-shell-and-vim/'>Writing small text filters for the shell and Vim</a> - <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr></li>
    <li><a href='../../notes/mapserver-postgis-performance/'>MapServer PostGIS Performance</a> - <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr></li>
    <li><a href='../../notes/postgres-information-functions/'>Postgres Information Functions</a> - <abbr class="published" title="2017-02-18T07:55:00+00:00">Sat 18 February 2017</abbr></li>
    <li><a href='../../notes/openlayers-2-custom-build/'>OpenLayers 2 Custom Build</a> - <abbr class="published" title="2016-04-26T14:00:00+01:00">Tue 26 April 2016</abbr></li>
    <li><a href='../../notes/testing-python-postgres/'>Testing Python &amp; Postgres</a> - <abbr class="published" title="2015-10-12T21:00:00+01:00">Mon 12 October 2015</abbr></li>
    <li><a href='../../notes/read-only-postgres-database/'>Read-only Postgres database</a> - <abbr class="published" title="2015-09-08T13:00:00+01:00">Tue 08 September 2015</abbr></li>
    <li><a href='../../notes/loading-postgis/'>Loading PostGIS</a> - <abbr class="published" title="2014-11-20T00:00:00+00:00">Thu 20 November 2014</abbr></li>
    <li><a href='../../notes/practical-openlayers-3-leaflet/'>Practical OpenLayers 3 &amp; Leaflet</a> - <abbr class="published" title="2014-09-07T21:30:00+01:00">Sun 07 September 2014</abbr></li>
    <li><a href='../../notes/gnu-parallel-all-the-things/'>GNU Parallel all the things!</a> - <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr></li>
    <li><a href='../../notes/first-few-months-of-clojure/'>First few months of Clojure</a> - <abbr class="published" title="2014-02-18T19:42:00+00:00">Tue 18 February 2014</abbr></li>
    <li><a href='../../notes/custom-geoserver-getfeatureinfo-template/'>Custom GeoServer GetFeatureInfo Template</a> - <abbr class="published" title="2013-10-18T17:24:00+01:00">Fri 18 October 2013</abbr></li>
    <li><a href='../../notes/using-leaflet-with-a-custom-projection-and-a-mapproxy-tms/'>Using Leaflet with a custom projection and a MapProxy TMS</a> - <abbr class="published" title="2012-07-02T21:06:00+01:00">Mon 02 July 2012</abbr></li>
    <li><a href='../../notes/greyscale-maps-with-mapserver/'>Greyscale maps with MapServer</a> - <abbr class="published" title="2012-02-02T21:31:00+00:00">Thu 02 February 2012</abbr></li>
    <li><a href='../../notes/disaggregate-multilinestrings-using-st_dump-postgis/'>Disaggregate MultiLineStrings using ST_Dump PostGIS</a> - <abbr class="published" title="2011-11-24T21:39:00+00:00">Thu 24 November 2011</abbr></li>
    <li><a href='../../notes/recursively-delete-empty-directories/'>Recursively delete empty directories</a> - <abbr class="published" title="2011-03-28T10:31:00+01:00">Mon 28 March 2011</abbr></li>
    <li><a href='../../notes/convert-a-directory-of-tiffs-to-greyscale-using-imagemagick/'>Convert a directory of TIFFs to greyscale using ImageMagick</a> - <abbr class="published" title="2011-01-07T17:53:00+00:00">Fri 07 January 2011</abbr></li>
    <li><a href='../../notes/build-ogr-18-with-gml-wfs-and-postgis-support-on-ubuntu-1004/'>Build OGR 1.8 with GML, WFS and PostGIS support on Ubuntu 10.04</a> - <abbr class="published" title="2010-12-19T21:06:00+00:00">Sun 19 December 2010</abbr></li>
</ul>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>