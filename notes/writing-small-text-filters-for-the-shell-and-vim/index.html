<!DOCTYPE html>
<html lang="en">
<head>
        <title>Writing small text filters for the shell and Vim</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, target-densitydpi=device-dpi">
        <link rel="stylesheet" href="https://longwayaround.org.uk/theme/css/main.css" type="text/css" />
        <link href="https://longwayaround.org.uk/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="longwayaround.org.uk RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie.css"/>
                <script src="https://longwayaround.org.uk/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://longwayaround.org.uk/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">longwayaround.org.uk  <strong>taking the scenic route and enjoying the journey</strong></a></h1>
                <nav>
                <ul>
                    <li class="active"><a href="https://longwayaround.org.uk/notes/">notes</a></li>
                </ul>
                </nav>
                    <ul class="social">
                        <li><a href="https://longwayaround.org.uk/feeds/all.rss.xml" rel="alternate"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/rss.png" title="rss" width="18" height="18" /></a></li>
                    <li><a href="https://uk.linkedin.com/in/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/linkedin.png" title="linkedin" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/organizations/AstunTechnology"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://github.com/walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/github.png" title="github" width="18" height="18" /></a></li>
                    <li><a href="https://twitter.com/_walkermatt"><img src="https://longwayaround.org.uk/theme/images/icons/gosquared/18/twitter.png" title="twitter" width="18" height="18" /></a></li>
                    </ul>
        </header><!-- /#banner -->
<section id="content" class="body">
<article>
        <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Writing small text filters for the shell and Vim">Writing small text filters for the shell and Vim</a></h1>  </header>
        <div class="entry-content">
        <p>Text filters are command-line programs that take text as input, transform it then output the results. An example of a common built in text filter is <tt class="docutils literal">sort</tt> which when passed newline separated text will sort each line:</p>
<div class="highlight"><pre><span></span><span class="nb">printf</span> <span class="s1">&#39;b\nc\na&#39;</span> <span class="p">|</span> sort
</pre></div>
<p>You can write your own text filter scripts; this is an example from my <a class="reference external" href="https://github.com/walkermatt/dotbin">~/.bin</a> directory which can be used to filter JSON text. It supports pretty printing the output as well as removing any formatting so that the JSON text is all on one line.</p>
<p><tt class="docutils literal">jsonformat</tt></p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--indent&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;indent&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--squash&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;squash&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; [infile [outfile]]&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">squash</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>The Python script makes use of the Python 3 <tt class="docutils literal">json</tt> package for reading and writing JSON and supports reading from standard input (<tt class="docutils literal">stdin</tt>) or a file and writing to standard out (<tt class="docutils literal">stdout</tt>) or file.</p>
<p>Assuming a file called <tt class="docutils literal">feature.json</tt> it can be pretty printed with an indentation of <tt class="docutils literal">2</tt> spaces to <tt class="docutils literal">stdout</tt> like so:</p>
<div class="highlight"><pre><span></span>jsonformat --indent <span class="m">2</span> features.json
</pre></div>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">[</span>
            <span class="p">[</span>
              <span class="mf">-2.407379150390625</span><span class="p">,</span>
              <span class="mf">52.36302183361385</span>
            <span class="p">],</span>
            <span class="p">[</span>
              <span class="mf">-2.3258399963378906</span><span class="p">,</span>
              <span class="mf">52.36302183361385</span>
            <span class="p">],</span>
            <span class="p">[</span>
              <span class="mf">-2.3258399963378906</span><span class="p">,</span>
              <span class="mf">52.41488029514571</span>
            <span class="p">],</span>
            <span class="p">[</span>
              <span class="mf">-2.407379150390625</span><span class="p">,</span>
              <span class="mf">52.41488029514571</span>
            <span class="p">],</span>
            <span class="p">[</span>
              <span class="mf">-2.407379150390625</span><span class="p">,</span>
              <span class="mf">52.36302183361385</span>
            <span class="p">]</span>
          <span class="p">]</span>
        <span class="p">],</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Wyre Forest&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Or output with formatting removed:</p>
<div class="highlight"><pre><span></span>jsonformat --squash features.json
</pre></div>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;features&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="nt">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mf">-2.407379150390625</span><span class="p">,</span> <span class="mf">52.36302183361385</span><span class="p">],</span> <span class="p">[</span><span class="mf">-2.3258399963378906</span><span class="p">,</span> <span class="mf">52.36302183361385</span><span class="p">],</span> <span class="p">[</span><span class="mf">-2.3258399963378906</span><span class="p">,</span> <span class="mf">52.41488029514571</span><span class="p">],</span> <span class="p">[</span><span class="mf">-2.407379150390625</span><span class="p">,</span> <span class="mf">52.41488029514571</span><span class="p">],</span> <span class="p">[</span><span class="mf">-2.407379150390625</span><span class="p">,</span> <span class="mf">52.36302183361385</span><span class="p">]]],</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">},</span> <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Wyre Forest&quot;</span><span class="p">},</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">}],</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">}</span>
</pre></div>
<div class="section" id="use-in-vim">
<h2>Use in Vim</h2>
<p>Assuming the script is in your system path it can then be used from within Vim to filter text within a buffer.</p>
<div class="section" id="format-program-formatprg">
<h3>Format program (<tt class="docutils literal">formatprg</tt>)</h3>
<p>Add the following to your <tt class="docutils literal">.vimrc</tt> to set <tt class="docutils literal">jsonformat</tt> as the <a class="reference external" href="https://vimhelp.org/options.txt.html#%27formatprg%27">format program</a> for JSON files:</p>
<div class="highlight"><pre><span></span><span class="k">au</span> <span class="nb">FileType</span> json <span class="k">setlocal</span> <span class="nb">formatprg</span><span class="p">=</span>jsonformat
</pre></div>
<p>When you have a buffer with a file type of JSON open you can then use <tt class="docutils literal">gq</tt> followed by a motion to invoke the format program. You can also select lines in visual mode and use <tt class="docutils literal">gq</tt> to format just those lines.</p>
</div>
<div class="section" id="execute-shell-command">
<h3>Execute shell command (<tt class="docutils literal">:!</tt>)</h3>
<p>It's also possible to select lines in visual mode then call <tt class="docutils literal">jsonformat</tt> <a class="reference external" href="https://vimhelp.org/various.txt.html#%3A%21">via the command-line mode</a> (the <tt class="docutils literal"><span class="pre">'&lt;,'&gt;</span></tt> are inserted for you and represent the range of the currently selected lines):</p>
<div class="highlight"><pre><span></span><span class="p">:</span><span class="s1">&#39;&lt;,&#39;</span><span class="p">&gt;!</span>jsonformat <span class="p">--</span>squash
</pre></div>
<p>This approach has the advantage of allowing options to be specified such as <tt class="docutils literal"><span class="pre">--squash</span></tt> in the above example.</p>
</div>
</div>

<footer class="post-info">
    <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr>
<p>Tags: <a href="https://longwayaround.org.uk/tag/vim.html">vim</a> <a href="https://longwayaround.org.uk/tag/bash.html">bash</a> <a href="https://longwayaround.org.uk/tag/sh.html">sh</a> <a href="https://longwayaround.org.uk/tag/python.html">python</a> </p></footer><!-- /.post-info -->        </div><!-- /.entry-content -->
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               // Don't set the identifier so that comments are
               // associated with the url
               // var disqus_identifier = "notes/writing-small-text-filters-for-the-shell-and-vim/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'https://longwayaroundorguk.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>

</article>
</section>
<section id="content" class="body">
<h1>Posts</h1>
<ul>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers-take-2/'>Web Mercator OS Vector Tile API in OpenLayers - Take #2</a> - <abbr class="published" title="2022-09-05T08:05:00+01:00">Mon 05 September 2022</abbr></li>
    <li><a href='../../notes/web-mercator-os-vector-tile-api-in-openlayers/'>Web Mercator OS Vector Tile API in OpenLayers</a> - <abbr class="published" title="2022-06-23T21:56:00+01:00">Thu 23 June 2022</abbr></li>
    <li><a href='../../notes/writing-small-text-filters-for-the-shell-and-vim/'>Writing small text filters for the shell and Vim</a> - <abbr class="published" title="2022-06-22T21:56:00+01:00">Wed 22 June 2022</abbr></li>
    <li><a href='../../notes/mapserver-postgis-performance/'>MapServer PostGIS Performance</a> - <abbr class="published" title="2019-09-20T12:00:00+01:00">Fri 20 September 2019</abbr></li>
    <li><a href='../../notes/postgres-information-functions/'>Postgres Information Functions</a> - <abbr class="published" title="2017-02-18T07:55:00+00:00">Sat 18 February 2017</abbr></li>
    <li><a href='../../notes/openlayers-2-custom-build/'>OpenLayers 2 Custom Build</a> - <abbr class="published" title="2016-04-26T14:00:00+01:00">Tue 26 April 2016</abbr></li>
    <li><a href='../../notes/testing-python-postgres/'>Testing Python &amp; Postgres</a> - <abbr class="published" title="2015-10-12T21:00:00+01:00">Mon 12 October 2015</abbr></li>
    <li><a href='../../notes/read-only-postgres-database/'>Read-only Postgres database</a> - <abbr class="published" title="2015-09-08T13:00:00+01:00">Tue 08 September 2015</abbr></li>
    <li><a href='../../notes/loading-postgis/'>Loading PostGIS</a> - <abbr class="published" title="2014-11-20T00:00:00+00:00">Thu 20 November 2014</abbr></li>
    <li><a href='../../notes/practical-openlayers-3-leaflet/'>Practical OpenLayers 3 &amp; Leaflet</a> - <abbr class="published" title="2014-09-07T21:30:00+01:00">Sun 07 September 2014</abbr></li>
    <li><a href='../../notes/gnu-parallel-all-the-things/'>GNU Parallel all the things!</a> - <abbr class="published" title="2014-07-17T19:45:00+01:00">Thu 17 July 2014</abbr></li>
    <li><a href='../../notes/first-few-months-of-clojure/'>First few months of Clojure</a> - <abbr class="published" title="2014-02-18T19:42:00+00:00">Tue 18 February 2014</abbr></li>
    <li><a href='../../notes/custom-geoserver-getfeatureinfo-template/'>Custom GeoServer GetFeatureInfo Template</a> - <abbr class="published" title="2013-10-18T17:24:00+01:00">Fri 18 October 2013</abbr></li>
    <li><a href='../../notes/using-leaflet-with-a-custom-projection-and-a-mapproxy-tms/'>Using Leaflet with a custom projection and a MapProxy TMS</a> - <abbr class="published" title="2012-07-02T21:06:00+01:00">Mon 02 July 2012</abbr></li>
    <li><a href='../../notes/greyscale-maps-with-mapserver/'>Greyscale maps with MapServer</a> - <abbr class="published" title="2012-02-02T21:31:00+00:00">Thu 02 February 2012</abbr></li>
    <li><a href='../../notes/disaggregate-multilinestrings-using-st_dump-postgis/'>Disaggregate MultiLineStrings using ST_Dump PostGIS</a> - <abbr class="published" title="2011-11-24T21:39:00+00:00">Thu 24 November 2011</abbr></li>
    <li><a href='../../notes/recursively-delete-empty-directories/'>Recursively delete empty directories</a> - <abbr class="published" title="2011-03-28T10:31:00+01:00">Mon 28 March 2011</abbr></li>
    <li><a href='../../notes/convert-a-directory-of-tiffs-to-greyscale-using-imagemagick/'>Convert a directory of TIFFs to greyscale using ImageMagick</a> - <abbr class="published" title="2011-01-07T17:53:00+00:00">Fri 07 January 2011</abbr></li>
    <li><a href='../../notes/build-ogr-18-with-gml-wfs-and-postgis-support-on-ubuntu-1004/'>Build OGR 1.8 with GML, WFS and PostGIS support on Ubuntu 10.04</a> - <abbr class="published" title="2010-12-19T21:06:00+00:00">Sun 19 December 2010</abbr></li>
</ul>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                    Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a> and <a href="http://python.org">Python</a>, using a modified <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a> theme, background from <a href="http://subtlepatterns.com">Subtle Patterns</a> and icons from <a href="https://www.gosquared.com/blog/archives/2925">GoSocial</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'longwayaroundorguk';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>